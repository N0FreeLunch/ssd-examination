services:
  # 1. Main Application
  app:
    container_name: examination-app-local
    build:
      context: .
      dockerfile: Dockerfile.dev
    restart: always
    ports:
      - "8180:8180"
    environment:
      - PORT=8180
      - DATABASE_URL=${DATABASE_URL:-sqlite://file:/data/local.db?_pragma=foreign_keys(1)&cache=shared&mode=rwc}
      - DB_PATH=/data/local.db
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - ADMIN_EMAIL=admin@example.com
      - ADMIN_PASSWORD=admin
    volumes:
      - ./:/app
      - sqlite-data:/data # Named volume for DB
      - go-modules:/go/pkg/mod # Module caching
    depends_on:
      mailpit:
        condition: service_started
      minio:
        condition: service_started
      restore-db:
        condition: service_completed_successfully

  # 2. SQLite Sidecar (Litestream)
  litestream:
    container_name: examination-litestream-local
    image: litestream/litestream:latest
    command: replicate -config /etc/litestream.yml
    volumes:
      - sqlite-data:/data
      - ./infra/config/litestream.local.yml:/etc/litestream.yml
    environment:
      - LITESTREAM_ACCESS_KEY_ID=minioadmin
      - LITESTREAM_SECRET_ACCESS_KEY=minioadmin
    depends_on:
      minio:
        condition: service_started
      restore-db:
        condition: service_completed_successfully

  # 3. Helpers
  mailpit:
    container_name: examination-mailpit
    image: axllent/mailpit
    ports:
      - "8125:8025"
      - "1025:1025"

  adminer:
    container_name: examination-adminer
    image: adminer:standalone
    ports:
      - "8181:8080"
    volumes:
      - sqlite-data:/data
      - ./infra/adminer/index.php:/var/www/html/index.php
    environment:
      - ADMINER_DEFAULT_SERVER=sqlite
      - ADMINER_DESIGN=nette
    depends_on:
      restore-db:
        condition: service_completed_successfully

  minio:
    container_name: examination-minio
    image: minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9100:9000"
      - "9101:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio-data:/data

  # Setup MinIO Buckets automatically
  setup-minio:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c " until (mc alias set minio http://minio:9000 minioadmin minioadmin); do echo '...waiting for minio...'; sleep 1; done; mc mb minio/backups || echo 'Bucket already exists'; exit 0; "

  # 4. Maintenance / Init
  restore-db:
    image: litestream/litestream:latest
    container_name: examination-db-restore
    entrypoint: /scripts/restore-db.sh
    volumes:
      - sqlite-data:/data
      - ./infra/config/litestream.local.yml:/etc/litestream.yml
      - ./infra/docker/restore-db.sh:/scripts/restore-db.sh:ro
    environment:
      - LITESTREAM_ACCESS_KEY_ID=minioadmin
      - LITESTREAM_SECRET_ACCESS_KEY=minioadmin
    depends_on:
      setup-minio:
        condition: service_completed_successfully

volumes:
  go-modules:
  minio-data:
  sqlite-data:
